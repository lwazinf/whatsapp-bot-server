// WhatsApp Bot Multi-Business Platform
// Inclusive of ALL business types - from informal street vendors to registered companies

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS
// ============================================================================

model User {
  id              String            @id @default(uuid())
  phone           String            @unique
  
  // Basic Info (collected over time, not required upfront)
  name            String?
  email           String?
  
  // Default Delivery Info (optional - collected when first ordering)
  defaultAddress  String?           @map("default_address")
  defaultLat      Decimal?          @map("default_lat") @db.Decimal(10, 7)
  defaultLng      Decimal?          @map("default_lng") @db.Decimal(10, 7)
  
  // Terms Acceptance
  acceptedTermsAt DateTime?         @map("accepted_terms_at")
  acceptedTermsVersion String?      @map("accepted_terms_version")
  
  isActive        Boolean           @default(true) @map("is_active")
  createdAt       DateTime          @default(now()) @map("created_at")
  lastOrderAt     DateTime?         @map("last_order_at")
  
  // Relationships
  orders          Order[]
  favorites       FavoriteBusiness[]
  ownedBusinesses BusinessOwner[]
  reviews         Review[]
  savedLocations  SavedLocation[]
  
  @@map("users")
}

model SavedLocation {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  label       String   // "Home", "Work", "Mom's place"
  address     String?  // Optional text address
  latitude    Decimal  @db.Decimal(10, 7)
  longitude   Decimal  @db.Decimal(10, 7)
  instructions String? // "Blue gate", "Ring twice"
  
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@map("saved_locations")
}

// ============================================================================
// BUSINESS - Supports ALL business types (informal to corporate)
// ============================================================================

model Business {
  id              String            @id @default(uuid())
  
  // Basic Info
  name            String
  slug            String            @unique
  description     String?
  category        String            // meat, restaurant, grocery, etc
  
  // Contact (Just phone is enough to start)
  phone           String
  email           String?
  address         String?           // Physical address (optional)
  
  // Location (Optional - for delivery radius calculation)
  latitude        Decimal?          @db.Decimal(10, 7)
  longitude       Decimal?          @db.Decimal(10, 7)
  
  // Welcome Message (sent via WhatsApp when user enters business)
  welcomeMessage  String?           @db.Text @map("welcome_message")
  
  // Delivery Settings
  offersDelivery  Boolean           @default(true) @map("offers_delivery")
  offersPickup    Boolean           @default(true) @map("offers_pickup")
  deliveryRadius  Decimal?          @default(10) @map("delivery_radius") @db.Decimal(5, 2) // km
  deliveryFee     Decimal           @default(30) @map("delivery_fee") @db.Decimal(10, 2)
  freeDeliveryThreshold Decimal     @default(500) @map("free_delivery_threshold") @db.Decimal(10, 2)
  
  // Business Status
  businessLevel   BusinessLevel     @default(INFORMAL) @map("business_level")
  status          BusinessStatus    @default(PENDING)
  isActive        Boolean           @default(true) @map("is_active")
  isVerified      Boolean           @default(false) @map("is_verified")
  
  // QR Code for business access
  qrCode          String            @unique @map("qr_code")
  qrCodeImage     String?           @map("qr_code_image") // Generated QR image data URL
  
  // Payment Methods (Business chooses what to accept)
  acceptsCash     Boolean           @default(true) @map("accepts_cash")
  acceptsEFT      Boolean           @default(false) @map("accepts_eft")
  acceptsCard     Boolean           @default(false) @map("accepts_card")
  
  // Payment Gateway Config (Only if accepting digital payments)
  ozowSiteCode    String?           @map("ozow_site_code")
  ozowPrivateKey  String?           @map("ozow_private_key")
  yocoSecretKey   String?           @map("yoco_secret_key")
  
  // BANKING DETAILS - For receiving payouts (collected when ready)
  bankName        String?           @map("bank_name")
  accountHolder   String?           @map("account_holder")
  accountNumber   String?           @map("account_number")
  accountType     String?           @map("account_type") // "cheque", "savings"
  branchCode      String?           @map("branch_code")
  
  // Banking Verification
  bankingVerified Boolean           @default(false) @map("banking_verified")
  bankProofDocument String?         @map("bank_proof_document") // Optional: bank statement/letter
  
  // OPTIONAL Registration Details (for formal businesses)
  registrationNumber String?        @map("registration_number") // CIPC/tax number
  vatNumber       String?           @map("vat_number")
  
  // OPTIONAL Compliance Documents (not required, but recommended)
  healthCert      String?           @map("health_cert")
  businessLicense String?           @map("business_license")
  
  // Platform Fee
  platformFeePercentage Decimal     @default(5) @map("platform_fee_percentage") @db.Decimal(5, 2)
  
  // Financial Tracking
  pendingPayout   Decimal           @default(0) @map("pending_payout") @db.Decimal(12, 2)
  totalPaidOut    Decimal           @default(0) @map("total_paid_out") @db.Decimal(12, 2)
  lastPayoutAt    DateTime?         @map("last_payout_at")
  
  // Terms Acceptance
  acceptedTermsAt DateTime?         @map("accepted_terms_at")
  acceptedTermsVersion String?      @map("accepted_terms_version")
  
  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  // Relationships
  owners          BusinessOwner[]
  products        Product[]
  orders          Order[]
  favoritedBy     FavoriteBusiness[]
  operatingHours  OperatingHours[]
  reviews         Review[]
  payouts         Payout[]
  
  @@index([status])
  @@index([category])
  @@index([businessLevel])
  @@index([qrCode])
  @@map("businesses")
}

// Business Level - Determines requirements and features
enum BusinessLevel {
  INFORMAL      // Street vendor, home business, no registration needed
  SMALL         // Small registered business (tax registered)
  MEDIUM        // Established business with employees
  CORPORATE     // Large company, full compliance
}

enum BusinessStatus {
  PENDING       // Awaiting approval
  ACTIVE        // Operating
  SUSPENDED     // Temporarily suspended
  CLOSED        // Permanently closed
}

// ============================================================================
// BUSINESS OWNERSHIP
// ============================================================================

model BusinessOwner {
  id          String        @id @default(uuid())
  userId      String        @map("user_id")
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessId  String        @map("business_id")
  business    Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  role        String        @default("owner") // "owner", "manager", "staff"
  isActive    Boolean       @default(true) @map("is_active")
  joinedAt    DateTime      @default(now()) @map("joined_at")
  
  @@unique([userId, businessId])
  @@map("business_owners")
}

// ============================================================================
// OPERATING HOURS
// ============================================================================

model OperatingHours {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  dayOfWeek   Int      @map("day_of_week") // 0 = Sunday, 6 = Saturday
  openTime    String   @map("open_time")   // "09:00"
  closeTime   String   @map("close_time")  // "18:00"
  isClosed    Boolean  @default(false) @map("is_closed")
  
  @@index([businessId])
  @@map("operating_hours")
}

// ============================================================================
// PRODUCTS
// ============================================================================

model Product {
  id          String      @id @default(uuid())
  businessId  String      @map("business_id")
  business    Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  name        String
  category    String
  description String?
  price       Decimal     @db.Decimal(10, 2)
  unit        String      // kg, pack, item
  inStock     Boolean     @default(true) @map("in_stock")
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  orderItems  OrderItem[]
  
  @@index([businessId])
  @@index([category])
  @@map("products")
}

// ============================================================================
// ORDERS - With QR Verification
// ============================================================================

model Order {
  id              String      @id @default(uuid())
  orderNumber     String      @unique @map("order_number")
  
  userId          String      @map("user_id")
  user            User        @relation(fields: [userId], references: [id])
  businessId      String      @map("business_id")
  business        Business    @relation(fields: [businessId], references: [id])
  
  // Amounts
  subtotal        Decimal     @db.Decimal(10, 2)
  deliveryFee     Decimal     @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  platformFee     Decimal     @default(0) @map("platform_fee") @db.Decimal(10, 2)
  grandTotal      Decimal     @map("grand_total") @db.Decimal(10, 2)
  
  // Order Status
  status          OrderStatus @default(PENDING)
  
  // Fulfillment
  fulfillmentType String      @default("delivery") @map("fulfillment_type") // delivery/pickup
  
  // Payment
  paymentMethod   String?     @map("payment_method") // cash/ozow/yoco
  paymentId       String?     @map("payment_id")
  paymentStatus   String      @default("pending") @map("payment_status")
  
  // ORDER QR CODE - Generated after payment
  orderQRCode     String?     @unique @map("order_qr_code")
  orderQRImage    String?     @map("order_qr_image") // QR image sent to customer
  qrGeneratedAt   DateTime?   @map("qr_generated_at")
  
  // QR SCAN - Driver scans to complete
  qrScannedAt     DateTime?   @map("qr_scanned_at")
  qrScannedBy     String?     @map("qr_scanned_by") // Driver phone
  qrScanLocation  Json?       @map("qr_scan_location") // {lat, lng, timestamp}
  
  // DELIVERY LOCATION
  deliveryAddress String?     @map("delivery_address")
  deliveryLat     Decimal?    @map("delivery_lat") @db.Decimal(10, 7)
  deliveryLng     Decimal?    @map("delivery_lng") @db.Decimal(10, 7)
  locationSharedAt DateTime?  @map("location_shared_at")
  deliveryNotes   String?     @map("delivery_notes")
  contactPhone    String?     @map("contact_phone")
  
  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  confirmedAt     DateTime?   @map("confirmed_at")
  preparingAt     DateTime?   @map("preparing_at")
  readyAt         DateTime?   @map("ready_at")
  dispatchedAt    DateTime?   @map("dispatched_at")
  arrivedAt       DateTime?   @map("arrived_at")
  deliveredAt     DateTime?   @map("delivered_at")
  cancelledAt     DateTime?   @map("cancelled_at")
  
  // Payout Tracking
  payoutId        String?     @map("payout_id")
  payoutProcessed Boolean     @default(false) @map("payout_processed")
  
  items           OrderItem[]
  
  @@index([userId])
  @@index([businessId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderQRCode])
  @@index([payoutProcessed])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String   @map("order_id")
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String   @map("product_id")
  product     Product  @relation(fields: [productId], references: [id])
  
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  subtotal    Decimal  @db.Decimal(10, 2)
  
  @@map("order_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  OUT_FOR_DELIVERY
  ARRIVED
  DELIVERED
  CANCELLED
}

// ============================================================================
// PAYOUTS - Every Friday
// ============================================================================

model Payout {
  id              String      @id @default(uuid())
  businessId      String      @map("business_id")
  business        Business    @relation(fields: [businessId], references: [id])
  
  // Period
  periodStart     DateTime    @map("period_start")
  periodEnd       DateTime    @map("period_end")
  
  // Amounts
  grossRevenue    Decimal     @map("gross_revenue") @db.Decimal(12, 2)
  platformFee     Decimal     @map("platform_fee") @db.Decimal(12, 2)
  netPayout       Decimal     @map("net_payout") @db.Decimal(12, 2)
  
  orderCount      Int         @map("order_count")
  orderIds        String[]    @map("order_ids")
  
  // Status
  status          String      @default("pending") // pending/processing/completed/failed
  
  // Banking
  bankName        String?     @map("bank_name")
  accountNumber   String?     @map("account_number")
  accountHolder   String?     @map("account_holder")
  paymentReference String?    @unique @map("payment_reference")
  
  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  scheduledFor    DateTime    @map("scheduled_for")
  processedAt     DateTime?   @map("processed_at")
  paidAt          DateTime?   @map("paid_at")
  
  notes           String?     @db.Text
  failureReason   String?     @map("failure_reason")
  
  @@index([businessId])
  @@index([status])
  @@index([scheduledFor])
  @@map("payouts")
}

// ============================================================================
// REVIEWS
// ============================================================================

model Review {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])
  businessId  String   @map("business_id")
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  rating      Int      // 1-5 stars
  comment     String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([businessId])
  @@map("reviews")
}

// ============================================================================
// FAVORITES
// ============================================================================

model FavoriteBusiness {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessId  String   @map("business_id")
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@unique([userId, businessId])
  @@map("favorite_businesses")
}

// ============================================================================
// SESSIONS
// ============================================================================

model Session {
  id          String   @id
  userId      String?  @map("user_id")
  businessId  String?  @map("business_id")
  data        Json
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================================================
// PLATFORM TERMS
// ============================================================================

model PlatformTerms {
  id          String   @id @default(uuid())
  version     String   @unique
  
  customerTerms String @db.Text @map("customer_terms")
  merchantTerms String @db.Text @map("merchant_terms")
  liabilityWaiver String @db.Text @map("liability_waiver")
  
  isActive    Boolean  @default(false) @map("is_active")
  effectiveDate DateTime @map("effective_date")
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@map("platform_terms")
}
